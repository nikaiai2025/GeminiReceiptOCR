# 作業指示（日本語）
日本語のレシート画像（PDF）を与えます。各ページ（各画像）について内容を読み取り、指定の項目を加工して**CSV（カンマ区切り）**で出力してください。

【共通出力ルール】
- 出力は**CSVデータのみ**とする。余計な説明文、注釈、解析ログを一切出力しないこと。
- 文字エンコーディング：**UTF-8**。行区切りはLF。
- CSVはRFC4180準拠とし、**各フィールドは必要に応じてダブルクオートで囲む**。フィールド内のダブルクオートは `""` に置換すること。
- 列の順序と列名（ヘッダ）は次のとおり（日本語）：  
  `ファイル名,ページ番号,日付,店名,合計金額,登録番号,アラート`

## 出力項目（厳密ルール）
1. `ファイル名` : PDFファイル名をそのまま表示（拡張子含む）。
2. `ページ番号` : PDF内のページ番号（１始まりの整数）。
3. `日付` : `YYYY-MM-DD` 形式。**年の表記が無い場合は以下の補完ルールを使う**：現在の年を仮定し、その日付が将来日（今日より後）になる場合は前年に置き換える（例：本日が2025-09-27で、表示が `12/01` → 2025-12-01 は将来なので 2024-12-01 にする）。年・月・日が全く読み取れない場合は `不明`。
4. `店名` : レシート発行者の正式名を出力。**法人名称とサービス名がある場合は法人名称を優先**（`株式会社`、`（株）`、`㈱`、`有限会社` 等を含む場合は法人名）。店名が長くカンマや改行を含む可能性があるため**必ずRFC4180に従って引用処理**すること。読み取れない場合は `不明`。
5. `合計金額` : レシート全体の合計金額のみ。**半角数字のみ（例：5520）**。以下の正規化を行う：全角数字→半角、通貨記号（￥, 円, ¥, €など）や空白を削除、千位区切りカンマを削除、小数点はドットで維持（ただし日本円は小数点なし）。マイナス／返金は `-` を先頭につける（例：`-1200`）。読み取れない場合は `不明`。**例外：外国通貨の場合は通貨記号＋半角数字（例：`€ 6.00`）とし、その場合はアラートに `外国レシート` を追加**。
6. `登録番号` : 「適格請求書発行事業者」登録番号。読み取り後、**ハイフンや空白を除去**して `T` で始まる13桁（正規化後 `^T\d{13}$`）かを判定。条件を満たさない場合は `不明`。
7. `アラート` : 読み取りに問題がある場合のみ出力（空欄可）。必須例：`外国レシート`、`日付不明`、`合計金額不明`、`登録番号不明`、`白紙/非レシート` 等。複数ある場合はセミコロン `;` で区切る。

## 文字の読み取りと加工の詳細（具体的手順）
- **推測や自動補正は行わないこと**（原則）。ただし年補完（上記ルール）は許容する。
- **文字種正規化**：全角→半角（数字・英字・ハイフン・スラッシュ・コロン等）、全角スペース削除、複数空白は単一空白へ。
- `合計金額` は数字以外を除去してから出力（例：`￥ 5,520` → `5520`）。小数点は `.` のみ許容。通貨が日本円以外であると明確な場合は通貨表記を残す（上記）。
- `登録番号` は読み取り後ハイフンとスペースを除去して `T` + 13桁にならなければ `不明`。
- **縦書き**の可能性があるため縦書き検出を行い、必要ならOCRモードを切替えること。
- **向き補正**：画像の向きが不明な場合は自動で向きを検出して正立させる（OCR実行前）。
- **複数レシートが１ページに混在する場合**：ページ内で個別領域を検出し、領域ごとに1行（1レシート）として出力する。領域分離ができない場合はページ単位で処理。
- **白紙や広告等の非レシートページ判定**：文字数閾値（例：有効文字数 < 10）や「合計」「小計」「￥」「計」などのキーワードが見つからない場合は非レシートと判断し、他の項目は `n/a` とする（`ファイル名` と `ページ番号` は出す）。

## その他運用に関する注意
- `ファイル名` と `ページ番号` の組み合わせで一意の識別子となるため、必要なら `ファイル名_page番号` の形式で内部キーを付与しても良い（出力CSVには含めない）。
- 必要であれば追加列 `OCR_confidence`（0-100%） を出力するオプションを付けられる（ユーザー側で検査や自動判定ルールを作りやすくなる）。
- 出力例（RFC4180準拠のクオートを適用）：

ファイル先頭にヘッダ行を必ず含めること：
